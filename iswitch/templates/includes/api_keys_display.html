{% if has_keys %}
<div style="margin-bottom: 2rem;">
    <div style="margin-bottom: 1.5rem;">
        <label
            style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-secondary); font-size: 0.875rem;">API
            Key</label>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <input type="text" value="{{ api_key }}" readonly
                style="flex: 1; padding: 0.65rem; height: 2.5rem; border: 1px solid var(--border-color); color: black; border-radius: 8px; background: #f9fafb; font-family: monospace; font-size: 0.875rem;">
            <button class="btn btn-secondary" onclick="copyToClipboard('{{ api_key }}', this)"
                style="white-space: nowrap; margin-bottom: auto;">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16"
                    style="display: inline-block; vertical-align: middle; margin-right: 0.25rem;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                </svg>
                Copy
            </button>
        </div>
    </div>

    <div
        style="padding: 1rem; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 8px; margin-bottom: 1.5rem;">
        <p style="margin: 0; font-size: 0.875rem; color: #92400e;">
            <strong>Note:</strong> Your API secret was shown only once during generation. If you've lost it, you'll need
            to regenerate your API keys.
        </p>
    </div>

    <button class="btn btn-danger" onclick="regenerateKeys()"
        style="display: inline-flex; align-items: center; gap: 0.5rem;">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="18" height="18">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
        Regenerate API Keys
    </button>
</div>

{% else %}
<div style="text-align: center; padding: 3rem 1.5rem;">
    <div
        style="width: 64px; height: 64px; margin: 0 auto 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; display: flex; align-items: center; justify-content: center;">
        <svg fill="none" stroke="white" viewBox="0 0 24 24" width="32" height="32">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
        </svg>
    </div>
    <h3 style="margin: 0 0 0.5rem 0; font-size: 1.25rem; font-weight: 600;">No API Keys Generated</h3>
    <p style="margin: 0 0 2rem 0; color: var(--text-secondary); font-size: 0.875rem;">Generate your API keys to start
        integrating with the iSwitch API</p>
    <button class="btn btn-primary" onclick="generateKeys()"
        style="display: inline-flex; align-items: center; gap: 0.5rem; font-size: 1rem; padding: 0.75rem 1.5rem;">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg>
        Generate API Keys
    </button>
</div>
{% endif %}

<script>
    // Make functions globally accessible
    window.copyToClipboard = function (text, button) {
        navigator.clipboard.writeText(text).then(() => {
            const originalText = button.innerHTML;
            button.innerHTML = `
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16" style="display: inline-block; vertical-align: middle; margin-right: 0.25rem;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            Copied!
        `;
            button.style.background = '#10b981';
            button.style.borderColor = '#10b981';

            setTimeout(() => {
                button.innerHTML = originalText;
                button.style.background = '';
                button.style.borderColor = '';
            }, 2000);
        });
    };

    // Get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function getCSRFToken() {
        return getCookie('csrf_token') || '';
    }

    window.generateKeys = function () {
        showConfirmDialog(
            'Generate API Keys',
            'This will generate new API keys for your account. Continue?',
            function () {
                fetch('/api/method/iswitch.api.generate_api_keys', {
                    method: 'GET',
                    credentials: 'same-origin'
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message && data.message.success) {
                            showSecretPopup(data.message.api_key, data.message.api_secret);
                        } else {
                            showErrorDialog('Error generating API keys: ' + (data.message?.error || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        showErrorDialog('Failed to generate API keys. Please try again.');
                        console.error('Error:', error);
                    });
            }
        );
    };

    window.regenerateKeys = function () {
        showConfirmDialog(
            'Regenerate API Keys',
            'WARNING: This will invalidate your current API keys. Any integrations using the old keys will stop working. Continue?',
            function () {
                fetch('/api/method/iswitch.api.generate_api_keys?regenerate=1', {
                    method: 'GET',
                    credentials: 'same-origin'
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message && data.message.success) {
                            showSecretPopup(data.message.api_key, data.message.api_secret);
                        } else {
                            showErrorDialog('Error regenerating API keys: ' + (data.message?.error || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        showErrorDialog('Failed to regenerate API keys. Please try again.');
                        console.error('Error:', error);
                    });
            }
        );
    };

    function showConfirmDialog(title, message, onConfirm) {
        // Store the callback globally
        window._pendingConfirmAction = onConfirm;

        const modal = document.createElement('div');
        modal.id = 'confirm-modal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;';

        modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 500px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);">
            <h3 style="margin: 0 0 1rem 0; font-size: 1.25rem; font-weight: 600;">${title}</h3>
            <p style="margin: 0 0 2rem 0; color: #6b7280; line-height: 1.5;">${message}</p>
            <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                <button onclick="window.closeConfirmDialog()" class="btn btn-secondary" style="padding: 0.625rem 1.25rem;">Cancel</button>
                <button onclick="window.confirmDialogAction()" class="btn btn-primary" style="padding: 0.625rem 1.25rem;">Continue</button>
            </div>
        </div>
    `;

        document.body.appendChild(modal);
    }

    window.closeConfirmDialog = function () {
        const modal = document.getElementById('confirm-modal');
        if (modal) {
            document.body.removeChild(modal);
        }
        window._pendingConfirmAction = null;
    };

    window.confirmDialogAction = function () {
        if (window._pendingConfirmAction) {
            window._pendingConfirmAction();
        }
        window.closeConfirmDialog();
    };

    window.closeErrorDialog = function () {
        const modal = document.getElementById('error-modal');
        if (modal) {
            document.body.removeChild(modal);
        }
    };

    function showErrorDialog(message) {
        const modal = document.createElement('div');
        modal.id = 'error-modal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;';

        modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 500px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                <div style="width: 48px; height: 48px; background: #ef4444; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <svg fill="none" stroke="white" viewBox="0 0 24 24" width="24" height="24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </div>
                <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600;">Error</h3>
            </div>
            <p style="margin: 0 0 2rem 0; color: #6b7280; line-height: 1.5;">${message}</p>
            <button onclick="closeErrorDialog()" class="btn btn-primary" style="width: 100%; padding: 0.625rem;">OK</button>
        </div>
    `;

        document.body.appendChild(modal);
    }

    window.closeSecretPopup = function () {
        const modal = document.getElementById('secret-modal');
        if (modal) {
            document.body.removeChild(modal);
        }
        // Reload the API keys display by triggering HTMX
        const apiKeysElement = document.getElementById('api-keys-display');
        if (apiKeysElement) {
            htmx.ajax('GET', '/api/method/iswitch.api.get_existing_keys', {
                target: '#api-keys-display',
                swap: 'innerHTML'
            });
        }
    };

    function showSecretPopup(apiKey, apiSecret) {
        const modal = document.createElement('div');
        modal.id = 'secret-modal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(74, 63, 143, 0.4); display: flex; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(8px);';

        modal.innerHTML = `
        <div style="background: linear-gradient(135deg, #4A3F8F 0%, #6B5FB8 100%); border-radius: 20px; padding: 2.5rem; max-width: 500px; width: 90%; box-shadow: 0 25px 50px -12px rgba(74, 63, 143, 0.4); position: relative; overflow: hidden;">
            <!-- Decorative circles -->
            <div style="position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: rgba(255,255,255,0.08); border-radius: 50%;"></div>
            <div style="position: absolute; bottom: -30px; left: -30px; width: 100px; height: 100px; background: rgba(255,255,255,0.08); border-radius: 50%;"></div>
            
            <div style="position: relative; z-index: 1;">
                <!-- Warning/Disclaimer on top -->
                <div style="background: rgba(255, 107, 107, 0.2); border-left: 4px solid #FF6B6B; border-radius: 12px; padding: 1.25rem 1.5rem; margin-bottom: 2rem; backdrop-filter: blur(10px);">
                    <p style="margin: 0; font-size: 0.875rem; color: white; line-height: 1.6;">
                        <strong style="display: block; margin-bottom: 0.5rem; font-size: 1rem;">⚠️ Important:</strong>
                        This is the only time you'll see your API secret. Store it securely - you won't be able to see it again.
                    </p>
                </div>

                <!-- API Secret Box -->
                <div style="background: rgba(255,255,255,0.12); border: 2px solid rgba(255,255,255,0.2); border-radius: 14px; padding: 1.75rem; backdrop-filter: blur(10px);">
                    <label style="display: block; margin-bottom: 1rem; font-weight: 700; font-size: 0.875rem; color: white; text-transform: uppercase; letter-spacing: 0.1em;">API Secret</label>
                    <div style="display: flex; gap: 0.75rem; align-items: center;">
                        <input id="secret-input" type="text" value="${apiSecret}" readonly style="flex: 1; padding: 1rem; border: none; border-radius: 10px; background: white; font-family: 'Courier New', monospace; font-size: 0.9rem; font-weight: 600; color: #2D2640; height: 48px;">
                        <button onclick="copyAndCloseSecret()" style="padding: 0 1.75rem; background: linear-gradient(135deg, #FF6B6B 0%, #FF5757 100%); color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; white-space: nowrap; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s; height: 48px; box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);" onmouseover="this.style.background='linear-gradient(135deg, #FF5757 0%, #FF4444 100%)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(255, 107, 107, 0.4)'" onmouseout="this.style.background='linear-gradient(135deg, #FF6B6B 0%, #FF5757 100%)'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(255, 107, 107, 0.3)'">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="18" height="18">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            </svg>
                            <span id="copy-btn-text">Copy</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

        document.body.appendChild(modal);
    }

    // Copy function that also closes the modal
    window.copyAndCloseSecret = function () {
        const input = document.getElementById('secret-input');
        const btnText = document.getElementById('copy-btn-text');

        input.select();
        document.execCommand('copy');

        btnText.innerHTML = `
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="18" height="18">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        Copied!
    `;

        setTimeout(() => {
            closeSecretPopup();
        }, 1000);
    };    
</script>